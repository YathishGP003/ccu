From bf787298789a73108ece232a547c76aa8cbcc11b Mon Sep 17 00:00:00 2001
From: Samjith Sadasivan <samjith@75f.io>
Date: Fri, 6 Jan 2023 14:35:50 -0600
Subject: [PATCH] Dcwb Enabled fix

---
 .../bo/building/system/dab/DabFullyModulatingRtu.java  |  6 +++---
 .../logic/bo/building/system/dab/DcwbProfileUtil.java  |  7 +++----
 .../java/a75f/io/logic/pubnub/DcwbConfigHandler.java   | 10 +++++++++-
 3 files changed, 15 insertions(+), 8 deletions(-)

diff --git a/logic/src/main/java/a75f/io/logic/bo/building/system/dab/DabFullyModulatingRtu.java b/logic/src/main/java/a75f/io/logic/bo/building/system/dab/DabFullyModulatingRtu.java
index 8a46e975d..7af788889 100644
--- a/logic/src/main/java/a75f/io/logic/bo/building/system/dab/DabFullyModulatingRtu.java
+++ b/logic/src/main/java/a75f/io/logic/bo/building/system/dab/DabFullyModulatingRtu.java
@@ -984,7 +984,7 @@ public class DabFullyModulatingRtu extends DabSystemProfile
                                    systemEquip.getId(), systemEquip.getTz());
         }
         
-        setConfigVal("dcwb and enabled",1);
+        setConfigVal("dcwb and enabled and not analog4 and not maximized and not adaptive",1);
         CCUHsApi.getInstance().scheduleSync();
     }
     
@@ -993,7 +993,7 @@ public class DabFullyModulatingRtu extends DabSystemProfile
      * Deletes all the necessary config/loop/output points for DCWB.
      */
     public void disableDcwb(CCUHsApi hayStack) {
-        setConfigVal("dcwb and enabled",0);
+        setConfigVal("dcwb and enabled and not analog4 and not maximized and not adaptive",0);
         setDcwbConfigEnabled(Tags.ANALOG1, 0);
         setDcwbConfigEnabled(Tags.ANALOG4, 0);
         deleteConfigPoints(hayStack);
@@ -1030,6 +1030,6 @@ public class DabFullyModulatingRtu extends DabSystemProfile
     }
     
     public boolean isDcwbEnabled() {
-        return CCUHsApi.getInstance().readDefaultVal("system and dcwb and enabled") > 0;
+        return CCUHsApi.getInstance().readDefaultVal("system and dcwb and enabled and not analog4 and not maximized and not adaptive") > 0;
     }
 }
diff --git a/logic/src/main/java/a75f/io/logic/bo/building/system/dab/DcwbProfileUtil.java b/logic/src/main/java/a75f/io/logic/bo/building/system/dab/DcwbProfileUtil.java
index 5eccf2684..7a33395bd 100644
--- a/logic/src/main/java/a75f/io/logic/bo/building/system/dab/DcwbProfileUtil.java
+++ b/logic/src/main/java/a75f/io/logic/bo/building/system/dab/DcwbProfileUtil.java
@@ -1,5 +1,6 @@
 package a75f.io.logic.bo.building.system.dab;
 
+import java.util.ArrayList;
 import java.util.HashMap;
 
 import a75f.io.api.haystack.CCUHsApi;
@@ -213,10 +214,8 @@ public class DcwbProfileUtil {
     
     
     private static void deleteConfigPoint(String query, CCUHsApi hayStack) {
-        HashMap point = hayStack.read("system and config and "+query);
-        if (!point.isEmpty()) {
-            hayStack.deleteWritablePoint(point.get("id").toString());
-        }
+        ArrayList<HashMap<Object, Object>> configPoints = hayStack.readAllEntities("system and config and "+query);
+        configPoints.forEach( point -> hayStack.deleteWritablePoint(point.get("id").toString()));
     }
     
     private static void deleteLoopPoint(String query, CCUHsApi hayStack) {
diff --git a/logic/src/main/java/a75f/io/logic/pubnub/DcwbConfigHandler.java b/logic/src/main/java/a75f/io/logic/pubnub/DcwbConfigHandler.java
index 58fcd39fd..7239a7d60 100644
--- a/logic/src/main/java/a75f/io/logic/pubnub/DcwbConfigHandler.java
+++ b/logic/src/main/java/a75f/io/logic/pubnub/DcwbConfigHandler.java
@@ -17,7 +17,8 @@ public class DcwbConfigHandler {
         
         int val = msgObject.get("val").getAsInt();
         DabFullyModulatingRtu systemProfile = (DabFullyModulatingRtu) L.ccu().systemProfile;
-        if (configPoint.getMarkers().contains(Tags.DCWB) && configPoint.getMarkers().contains(Tags.ENABLED)) {
+        if (isDcwbEnabledPoint(configPoint)) {
+            CcuLog.i(L.TAG_CCU_PUBNUB, "updateDcwbEnabled status "+val);
             if (val > 0)
                 systemProfile.enableDcwb(hayStack);
             else
@@ -44,4 +45,11 @@ public class DcwbConfigHandler {
             CcuLog.e(L.TAG_CCU_PUBNUB, "Failed to parse tuner value : "+msgObject+" ; "+e.getMessage());
         }
     }
+
+    //Many points have "dcwb" and "enabled" tags , this is getting messy.
+    private static boolean isDcwbEnabledPoint(Point configPoint) {
+        return configPoint.getMarkers().contains(Tags.DCWB) && configPoint.getMarkers().contains(Tags.ENABLED) &&
+                (!configPoint.getMarkers().contains(Tags.ANALOG4) && !configPoint.getMarkers().contains(Tags.ADAPTIVE) &&
+                        !configPoint.getMarkers().contains(Tags.MAXIMIZED));
+    }
 }
-- 
2.37.3

