From d9cc4fc2e2e1ae50d9452bd2278578cf11e40821 Mon Sep 17 00:00:00 2001
From: Bharathpanchakshari
 <33091312+Bharathpanchakshari@users.noreply.github.com>
Date: Tue, 21 Jun 2022 16:44:58 +0530
Subject: [PATCH 09/35] 10649 implemented true CFM for tuners

---
 .../registration/InstallerOptions.java        | 31 +++++++++
 .../tuners/DialogTunerPriorityArray.java      | 67 +++++++++++++++++--
 .../tuners/TunerExpandableGridAdapter.java    | 51 +++++++++++++-
 .../a75f/io/renatus/tuners/TunerFragment.java | 25 +++++++
 .../fragment_installeroption.xml              |  2 +-
 .../res/layout/fragment_installeroption.xml   |  2 +-
 app/src/main/res/values/preference_keys.xml   |  1 +
 .../java/a75f/io/logic/bo/util/UnitUtils.java | 20 +++++-
 .../a75f/io/logic/tuners/GenericTuners.java   | 17 ++++-
 .../a75f/io/logic/tuners/TunerConstants.java  |  2 +
 10 files changed, 206 insertions(+), 12 deletions(-)

diff --git a/app/src/main/java/a75f/io/renatus/registration/InstallerOptions.java b/app/src/main/java/a75f/io/renatus/registration/InstallerOptions.java
index c9d2722fa..e7b1307ea 100644
--- a/app/src/main/java/a75f/io/renatus/registration/InstallerOptions.java
+++ b/app/src/main/java/a75f/io/renatus/registration/InstallerOptions.java
@@ -5,6 +5,7 @@ import android.content.BroadcastReceiver;
 import android.content.Context;
 import android.content.Intent;
 import android.content.IntentFilter;
+import android.content.SharedPreferences;
 import android.net.ConnectivityManager;
 import android.os.AsyncTask;
 import android.os.Build;
@@ -55,6 +56,7 @@ import a75f.io.logic.Globals;
 import a75f.io.logic.L;
 import a75f.io.logic.bo.building.definitions.ProfileType;
 import a75f.io.logic.tuners.BuildingTuners;
+import a75f.io.logic.tuners.TunerConstants;
 import a75f.io.logic.tuners.TunerUtil;
 import a75f.io.renatus.BuildConfig;
 import a75f.io.renatus.R;
@@ -92,6 +94,7 @@ public class InstallerOptions extends Fragment {
     String mSiteId;
     String addressBandSelected = "1000";
     Prefs prefs;
+    SharedPreferences sharedPreferences;
     String localSiteID;
     String CCU_ID = "";
     private boolean isFreshRegister;
@@ -108,6 +111,8 @@ public class InstallerOptions extends Fragment {
 
     //BACnet Setup
     ToggleButton toggleBACnet;
+    ToggleButton toggleCelsius;
+    TextView textCelsiusEnable;
     RelativeLayout relativeLayoutBACnet;
     EditText editIPAddr,editSubnet,editGateway;
     Button buttonInitialise;
@@ -211,6 +216,8 @@ public class InstallerOptions extends Fragment {
 
         //BACnet Setup UI Components
         toggleBACnet = rootView.findViewById(R.id.toggleBACnet);
+        toggleCelsius= rootView.findViewById(R.id.toggleCelsius);
+        textCelsiusEnable = rootView.findViewById(R.id.textUseCelsius);
         relativeLayoutBACnet = rootView.findViewById(R.id.relativeLayoutBACnet);
         editIPAddr = rootView.findViewById(R.id.editIPaddr);
         editSubnet = rootView.findViewById(R.id.editSubnet);
@@ -239,6 +246,16 @@ public class InstallerOptions extends Fragment {
 		HRef ccuId = CCUHsApi.getInstance().getCcuRef();
         String ccuUid = null;
 
+        textCelsiusEnable.setVisibility(View.VISIBLE);
+        toggleCelsius.setVisibility(View.VISIBLE);
+        HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("useCelsius");
+
+        if( (double) getTuner(useCelsius.get("id").toString())==TunerConstants.USE_CELSIUS_FLAG_ENABLED) {
+            toggleCelsius.setChecked(true);
+        } else {
+            toggleCelsius.setChecked(false);
+        }
+
         if (ccuId != null) {
             ccuUid = CCUHsApi.getInstance().getCcuRef().toString();
         }
@@ -251,6 +268,8 @@ public class InstallerOptions extends Fragment {
             if(CCUHsApi.getInstance().isCCURegistered() && ccuUid != null){
                 textBacnetEnable.setVisibility(View.VISIBLE);
                 toggleBACnet.setVisibility(View.VISIBLE);
+                textCelsiusEnable.setVisibility(View.VISIBLE);
+                toggleCelsius.setVisibility(View.VISIBLE);
             }else {
                 textBacnetEnable.setVisibility(View.GONE);
                 toggleBACnet.setVisibility(View.GONE);
@@ -384,6 +403,18 @@ public class InstallerOptions extends Fragment {
 
         getTempValues();
 
+        toggleCelsius.setOnCheckedChangeListener((buttonView, isChecked) -> {
+
+            if(isChecked) {
+                CCUHsApi.getInstance().writePoint(useCelsius.get("id").toString(), TunerConstants.TUNER_BUILDING_VAL_LEVEL,
+                        CCUHsApi.getInstance().getCCUUserName(), 1.0, 0);
+            } else {
+                CCUHsApi.getInstance().writePoint(useCelsius.get("id").toString(), TunerConstants.TUNER_BUILDING_VAL_LEVEL,
+                        CCUHsApi.getInstance().getCCUUserName(), 0.0, 0);
+            }
+            getTempValues();
+        });
+
         toggleBACnet.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {
             @Override
             public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
diff --git a/app/src/main/java/a75f/io/renatus/tuners/DialogTunerPriorityArray.java b/app/src/main/java/a75f/io/renatus/tuners/DialogTunerPriorityArray.java
index faeab6ffc..67a237378 100644
--- a/app/src/main/java/a75f/io/renatus/tuners/DialogTunerPriorityArray.java
+++ b/app/src/main/java/a75f/io/renatus/tuners/DialogTunerPriorityArray.java
@@ -34,14 +34,22 @@ import a75f.io.api.haystack.CCUHsApi;
 import a75f.io.api.haystack.Equip;
 import a75f.io.api.haystack.Floor;
 import a75f.io.api.haystack.HSUtil;
+import a75f.io.api.haystack.Tags;
 import a75f.io.api.haystack.Zone;
+import a75f.io.logic.tuners.TunerConstants;
 import a75f.io.renatus.BASE.BaseDialogFragment;
 import a75f.io.renatus.R;
 import a75f.io.renatus.util.CCUUiUtil;
 import a75f.io.renatus.util.CCUUtils;
+import a75f.io.renatus.util.Prefs;
 import a75f.io.renatus.util.TunerNumberPicker;
+import a75f.io.renatus.views.MasterControl.MasterControlView;
 import butterknife.ButterKnife;
 
+import static a75f.io.logic.bo.util.UnitUtils.fahrenheitToCelsius;
+import static a75f.io.logic.bo.util.UnitUtils.fahrenheitToCelsiusUnitChange;
+import static a75f.io.logic.bo.util.UnitUtils.round;
+import static a75f.io.logic.bo.util.UnitUtils.roundToHalf;
 
 
 
@@ -61,8 +69,13 @@ public class DialogTunerPriorityArray extends BaseDialogFragment implements Prio
     String selectedTunerValue;
     String selectedTunerLevel;
     String tunerGroupType;
+    String tunerName;
+    String tunerVal;
     LinearLayout viewStub;
     LinearLayout layoutTitle;
+    Prefs prefs;
+    double defaultVal;
+    HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("useCelsius");
 
 
     private void configureArguments(HashMap tunerItem, String tunerGroupType, TunerGroupItem tunerGroupItem) {
@@ -261,13 +274,26 @@ public class DialogTunerPriorityArray extends BaseDialogFragment implements Prio
     @Override
     public void onViewCreated(View view, @Nullable Bundle savedInstanceState) {
 
-         String tunerName = tunerItemSelected.get("dis").toString();
+        defaultVal = getTunerDefaultValue(tunerItemSelected.get("id").toString());
+
+        HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("useCelsius");
+        tunerName = tunerItemSelected.get("dis").toString();
+        if( (double) MasterControlView.getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED) {
+            if (tunerItemSelected.containsKey("unit") && tunerItemSelected.get("unit").toString().equals("\u00B0F") || tunerItemSelected.get("unit").toString().equals("\u00B0C")) {
+                if (doesPointNeedRelativeConversion()) {
+                    defaultVal = roundToHalf(fahrenheitToCelsiusUnitChange(defaultVal));
+                } else {
+                    defaultVal = Math.round(fahrenheitToCelsius(defaultVal));
+                }
+            }
+        }
+
         if (tunerItemSelected.containsKey("unit")) {
             textTunerName.setText(tunerName.substring(tunerName.lastIndexOf("-") + 1) + " (" + tunerItemSelected.get("unit").toString().toUpperCase() + ")");
-            textTunerDefaultValue.setText(getTunerDefaultValue(tunerItemSelected.get("id").toString()) + " (" + tunerItemSelected.get("unit").toString().toUpperCase() + ")");
+            textTunerDefaultValue.setText(defaultVal + " (" + tunerItemSelected.get("unit").toString().toUpperCase() + ")");
         } else {
             textTunerName.setText(tunerName.substring(tunerName.lastIndexOf("-") + 1));
-            textTunerDefaultValue.setText("" + getTunerDefaultValue(tunerItemSelected.get("id").toString()));
+            textTunerDefaultValue.setText("" + defaultVal);
         }
 
         textTunerGroupTitle.setText(tunerGroupSelected.getName());
@@ -294,6 +320,10 @@ public class DialogTunerPriorityArray extends BaseDialogFragment implements Prio
         buttonCancel.setOnClickListener(v -> dismiss());
     }
 
+    public boolean doesPointNeedRelativeConversion() {
+        return  tunerItemSelected.containsKey("deadband") || tunerItemSelected.containsKey("setback") || tunerItemSelected.containsKey("abnormal") || (tunerItemSelected.containsKey("spread") && tunerItemSelected.containsKey("user") && !tunerItemSelected.containsKey("multiplier")) || tunerItemSelected.containsKey("sat") && tunerItemSelected.containsKey("spmax") || tunerItemSelected.containsKey("spmin") || tunerItemSelected.containsKey("spres") || tunerItemSelected.containsKey("spinit") || tunerItemSelected.containsKey("sptrim") || tunerItemSelected.containsKey("spresmax") || (tunerItemSelected.containsKey("reheat") && tunerItemSelected.containsKey("min") && tunerItemSelected.containsKey("differential")) || tunerItemSelected.containsKey("leeway") || tunerItemSelected.containsKey("proportional");
+    }
+
 
     public double getTunerValue(String id) {
         CCUHsApi hayStack = CCUHsApi.getInstance();
@@ -348,14 +378,25 @@ public class DialogTunerPriorityArray extends BaseDialogFragment implements Prio
         return 0;
     }
 
-    public String getTunerValue(String id, String level) {
+    private String getTunerValue(String id, String level) {
         CCUHsApi hayStack = CCUHsApi.getInstance();
         ArrayList values = hayStack.readPoint(id);
         if (values != null && values.size() > 0) {
             for (int l = 1; l <= values.size(); l++) {
                 HashMap valMap = ((HashMap) values.get(l - 1));
                 if (valMap.get("level").toString().equals(level) && valMap.get("val") != null) {
-                    return valMap.get("val").toString();
+                    tunerVal = valMap.get("val").toString();
+                    if( (double) MasterControlView.getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED) {
+                        if (tunerItemSelected.containsKey("unit") && tunerItemSelected.get("unit").toString().equals("\u00B0F") || tunerItemSelected.get("unit").toString().equals("\u00B0C")) {
+                            if (doesPointNeedRelativeConversion()) {
+                                tunerVal = String.valueOf(roundToHalf(fahrenheitToCelsiusUnitChange(Double.parseDouble(valMap.get("val").toString()))));
+                            } else {
+                                tunerVal = String.valueOf(Math.round(fahrenheitToCelsius(Double.parseDouble(valMap.get("val").toString()))));
+                            }
+                        }
+
+                    }
+                    return tunerVal;
                 }
             }
         }
@@ -381,6 +422,7 @@ public class DialogTunerPriorityArray extends BaseDialogFragment implements Prio
             buttonUndo.setVisibility(View.GONE);
             buttonSaveAlert.setEnabled(false);
             String levelName = "Building";
+            prefs = new Prefs(getContext().getApplicationContext());
             int level;
             if (position == 15) {
                 levelName = "Building";
@@ -428,6 +470,21 @@ public class DialogTunerPriorityArray extends BaseDialogFragment implements Prio
                 double maxValueDb = (Double.parseDouble((tunerItemSelected.get("maxVal").toString())));
                 double incrementValDb = (Double.parseDouble(tunerItemSelected.get("incrementVal").toString()));
 
+                if( (double) MasterControlView.getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED) {
+                    if (tunerItemSelected.containsKey("unit") && tunerItemSelected.get("unit").toString().equals("\u00B0F") || tunerItemSelected.get("unit").toString().equals("\u00B0C")) {
+                        prefs.setBoolean(tunerItemSelected.get("id").toString(), true);
+                        if (doesPointNeedRelativeConversion()) {
+                            maxValueDb = roundToHalf(fahrenheitToCelsiusUnitChange(maxValueDb));
+                            minValueDb = roundToHalf(fahrenheitToCelsiusUnitChange(minValueDb));
+                            currentValueDb = roundToHalf(fahrenheitToCelsiusUnitChange(currentValueDb));
+                        } else {
+                            minValueDb = roundToHalf(fahrenheitToCelsius(minValueDb));
+                            maxValueDb = roundToHalf(fahrenheitToCelsius(maxValueDb));
+                            currentValueDb = roundToHalf(fahrenheitToCelsius(currentValueDb));
+                        }
+                    }
+                }
+
                 Log.i("TunersUI", "currentValue:" + currentValue + " minValue:" + minValue + " maxValue:" + maxValue + " incVal:" + incrementVal);
 
                 ArrayList<String> valueList = new ArrayList<>();
diff --git a/app/src/main/java/a75f/io/renatus/tuners/TunerExpandableGridAdapter.java b/app/src/main/java/a75f/io/renatus/tuners/TunerExpandableGridAdapter.java
index 9aef57c4b..338d363b8 100644
--- a/app/src/main/java/a75f/io/renatus/tuners/TunerExpandableGridAdapter.java
+++ b/app/src/main/java/a75f/io/renatus/tuners/TunerExpandableGridAdapter.java
@@ -6,6 +6,7 @@ import android.app.Activity;
 import android.content.Context;
 import android.content.Intent;
 import android.graphics.Color;
+import android.content.SharedPreferences;
 import androidx.cardview.widget.CardView;
 import androidx.recyclerview.widget.GridLayoutManager;
 import androidx.recyclerview.widget.RecyclerView;
@@ -16,12 +17,20 @@ import android.view.ViewGroup;
 import android.widget.ImageButton;
 import android.widget.TextView;
 import android.widget.ToggleButton;
+import static a75f.io.logic.bo.util.UnitUtils.fahrenheitToCelsius;
+import static a75f.io.logic.bo.util.UnitUtils.fahrenheitToCelsiusUnitChange;
+import static a75f.io.logic.bo.util.UnitUtils.round;
+import static a75f.io.logic.bo.util.UnitUtils.roundToHalf;
 
 import java.util.ArrayList;
 import java.util.HashMap;
 
 import a75f.io.api.haystack.CCUHsApi;
+import a75f.io.api.haystack.Tags;
+import a75f.io.logic.tuners.TunerConstants;
 import a75f.io.renatus.R;
+import a75f.io.renatus.util.Prefs;
+import a75f.io.renatus.views.MasterControl.MasterControlView;
 
 public class TunerExpandableGridAdapter extends RecyclerView.Adapter<TunerExpandableGridAdapter.ViewHolder> {
 
@@ -44,6 +53,8 @@ public class TunerExpandableGridAdapter extends RecyclerView.Adapter<TunerExpand
     int childIndexPosition = 0;
     TunerGroupItem previousOpenGroup = null;
     String tunerGroupType = "Building";
+    SharedPreferences mPreferences;
+    HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("useCelsius");
 
     public TunerExpandableGridAdapter(Context context, ArrayList<Object> dataArrayList,
                                       final GridLayoutManager gridLayoutManager, TunerItemClickListener itemClickListener,
@@ -63,6 +74,10 @@ public class TunerExpandableGridAdapter extends RecyclerView.Adapter<TunerExpand
         });
     }
 
+    public Context getmContext() {
+        return mContext;
+    }
+
     private boolean isSection(int position) {
         return mDataArrayList.get(position) instanceof TunerGroupItem;
     }
@@ -81,7 +96,8 @@ public class TunerExpandableGridAdapter extends RecyclerView.Adapter<TunerExpand
                 final HashMap tunerItem = (HashMap) mDataArrayList.get(position);
                 Log.i("TunersUI", "tunerItem:" + tunerItem);
                 String tunerName = tunerItem.get("dis").toString();
-                
+                Prefs prefs = new Prefs(getmContext().getApplicationContext());
+
                 holder.itemTextView.setText(tunerName.substring(tunerName.lastIndexOf("-") + 1));
                 if (tunerItem.containsKey("newValue")) {
                     if (tunerItem.get("newValue") == null){
@@ -92,7 +108,17 @@ public class TunerExpandableGridAdapter extends RecyclerView.Adapter<TunerExpand
                             holder.imgBtnUndo.setVisibility(View.GONE);
                         }
                     } else {
-                        holder.itemTextValueView.setText(tunerItem.get("newValue").toString());
+                        String val = tunerItem.get("newValue").toString();
+                        if( (double) MasterControlView.getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED && !prefs.getBoolean(tunerItem.get("id").toString())) {
+                            if (tunerItem.containsKey("unit") && tunerItem.get("unit").toString().equals("\u00B0F") || tunerItem.get("unit").toString().equals("\u00B0C")) {
+                                if (doesPointNeedRelativeConversion(tunerItem)) {
+                                    val = String.valueOf(roundToHalf(fahrenheitToCelsiusUnitChange(Double.parseDouble(val))));
+                                } else {
+                                    val = String.valueOf(Math.round(fahrenheitToCelsius(Double.parseDouble(val))));
+                                }
+                            }
+                        }
+                        holder.itemTextValueView.setText(val);
                         if (tunerItem.containsKey("hideRefresh")){
                             holder.imgBtnUndo.setVisibility(View.GONE);
                         } else {
@@ -102,12 +128,27 @@ public class TunerExpandableGridAdapter extends RecyclerView.Adapter<TunerExpand
                 } else {
                     holder.imgBtnUndo.setVisibility(View.GONE);
                     if (getTunerValue(tunerItem.get("id").toString()) != null){
-                        holder.itemTextValueView.setText(String.valueOf(getTunerValue(tunerItem.get("id").toString())));
+                        double val = (getTunerValue(tunerItem.get("id").toString()));
+                        if( (double) MasterControlView.getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED && !prefs.getBoolean(tunerItem.get("id").toString())) {
+                            if (tunerItem.containsKey("unit") && tunerItem.get("unit").toString().equals("\u00B0F") || tunerItem.get("unit").toString().equals("\u00B0C")) {
+                                if (doesPointNeedRelativeConversion(tunerItem)) {
+                                    val = roundToHalf(fahrenheitToCelsiusUnitChange(val));
+                                } else {
+                                    val = Math.round(fahrenheitToCelsius(val));
+                                }
+                            }
+                        }
+                        holder.itemTextValueView.setText(String.valueOf(val));
                     } else {
                         holder.itemTextValueView.setText("-");
                     }
                 }
                 if (tunerItem.containsKey("unit")) {
+                    if( (double) MasterControlView.getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED) {
+                        if (tunerItem.get("unit").toString().equals("\u00B0F")) {
+                            tunerItem.put("unit", "\u00B0C");
+                        }
+                    }
                     holder.itemTextView.setText(tunerName.substring(tunerName.lastIndexOf("-") + 1) + " (" + tunerItem.get("unit").toString().toUpperCase() + ")");
                 } else {
                     holder.itemTextView.setText(tunerName.substring(tunerName.lastIndexOf("-") + 1));
@@ -169,6 +210,10 @@ public class TunerExpandableGridAdapter extends RecyclerView.Adapter<TunerExpand
         }
     }
 
+    private boolean doesPointNeedRelativeConversion(HashMap<Object,Object> tunerItem) {
+        return  tunerItem.containsKey("deadband") || tunerItem.containsKey("setback") || tunerItem.containsKey("abnormal") || (tunerItem.containsKey("spread") && tunerItem.containsKey("user") && !tunerItem.containsKey("multiplier")) || tunerItem.containsKey("sat") && tunerItem.containsKey("spmax") || tunerItem.containsKey("spmin") || tunerItem.containsKey("spres") || tunerItem.containsKey("spinit") || tunerItem.containsKey("sptrim") || tunerItem.containsKey("spresmax") || (tunerItem.containsKey("reheat") && tunerItem.containsKey("min") && tunerItem.containsKey("differential")) || tunerItem.containsKey("leeway") || tunerItem.containsKey("proportional");
+    }
+
     @Override
     public int getItemCount() {
         return mDataArrayList.size();
diff --git a/app/src/main/java/a75f/io/renatus/tuners/TunerFragment.java b/app/src/main/java/a75f/io/renatus/tuners/TunerFragment.java
index 2b5baa255..7f9490009 100644
--- a/app/src/main/java/a75f/io/renatus/tuners/TunerFragment.java
+++ b/app/src/main/java/a75f/io/renatus/tuners/TunerFragment.java
@@ -53,14 +53,21 @@ import a75f.io.api.haystack.CCUHsApi;
 import a75f.io.api.haystack.Equip;
 import a75f.io.api.haystack.Floor;
 import a75f.io.api.haystack.HSUtil;
+import a75f.io.api.haystack.Tags;
 import a75f.io.api.haystack.Zone;
 import a75f.io.api.haystack.sync.HttpUtil;
 import a75f.io.logic.L;
 import a75f.io.logic.bo.building.definitions.ProfileType;
+import a75f.io.logic.tuners.TunerConstants;
 import a75f.io.renatus.BASE.BaseDialogFragment;
 import a75f.io.renatus.R;
 import a75f.io.renatus.util.CCUUiUtil;
+import a75f.io.renatus.util.Prefs;
+import a75f.io.renatus.views.MasterControl.MasterControlView;
 
+import static a75f.io.logic.bo.util.UnitUtils.celsiusToFahrenheit;
+import static a75f.io.logic.bo.util.UnitUtils.celsiusToFahrenheitUnitChange;
+import static a75f.io.logic.bo.util.UnitUtils.roundToHalf;
 
 
 
@@ -90,6 +97,7 @@ public class TunerFragment extends BaseDialogFragment implements TunerItemClickL
     Spinner spinnerSelection;
     ArrayList<HashMap> tuners = new ArrayList<>();
     String tunerGroupType = "Building";
+    Prefs prefs;
     public TunerFragment() {
     }
 
@@ -119,6 +127,7 @@ public class TunerFragment extends BaseDialogFragment implements TunerItemClickL
         cancelTunerUpdate = view.findViewById(R.id.buttonCancel);
         editChangeReason = view.findViewById(R.id.editChangeReason);
         editTunerSearch = view.findViewById(R.id.editTunerSearch);
+        HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("useCelsius");
         saveTunerValues.setEnabled(false);
         //Default Show System Tuners
         //TODO: revert building tuners
@@ -322,7 +331,18 @@ public class TunerFragment extends BaseDialogFragment implements TunerItemClickL
             Button buttonApplyTuners = dialogView.findViewById(R.id.buttonApplyTuner);
             Button buttonCancelTuners = dialogView.findViewById(R.id.buttonCancelTuner);
             buttonApplyTuners.setOnClickListener(dialogV -> {
+                prefs = new Prefs(getContext().getApplicationContext());
                 for (HashMap newTunerValueItem : updatedTunerValues) {
+                    if( (double) MasterControlView.getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED  || prefs.getBoolean(newTunerValueItem.get("id").toString())) {
+                        if (newTunerValueItem.containsKey("unit") && newTunerValueItem.get("unit").toString().equals("\u00B0F") || newTunerValueItem.get("unit").toString().equals("\u00B0C")) {
+                            if (doesPointNeedRelativeConversion(newTunerValueItem)) {
+                                newTunerValueItem.replace("newValue", String.valueOf(roundToHalf(celsiusToFahrenheitUnitChange(Double.parseDouble(newTunerValueItem.get("newValue").toString())))));
+                            } else {
+                                newTunerValueItem.replace("newValue", String.valueOf(Math.round(celsiusToFahrenheit(Double.parseDouble(newTunerValueItem.get("newValue").toString())))));
+                            }
+                            prefs.setBoolean(newTunerValueItem.get("id").toString(), false);
+                        }
+                    }
                     if ((newTunerValueItem.get("newLevel").toString().equals("16") || newTunerValueItem.get("newLevel").toString().equals("14")) && newTunerValueItem.get("tunerGroup").toString().contains("VAV") || newTunerValueItem.get("tunerGroup").toString().contains("DAB")) {
                         if (!newTunerValueItem.get("tunerGroup").toString().equalsIgnoreCase(getSystemProfileType())) {
                             continue;
@@ -475,6 +495,11 @@ public class TunerFragment extends BaseDialogFragment implements TunerItemClickL
     }
 
 
+    private boolean doesPointNeedRelativeConversion(HashMap<Object,Object> newTunerValueItem) {
+        return  newTunerValueItem.containsKey("deadband") || newTunerValueItem.containsKey("setback") || newTunerValueItem.containsKey("abnormal") || (newTunerValueItem.containsKey("spread") && newTunerValueItem.containsKey("user") && !newTunerValueItem.containsKey("multiplier")) || newTunerValueItem.containsKey("sat") && newTunerValueItem.containsKey("spmax") || newTunerValueItem.containsKey("spmin") || newTunerValueItem.containsKey("spres") || newTunerValueItem.containsKey("spinit") || newTunerValueItem.containsKey("sptrim") || newTunerValueItem.containsKey("spresmax") || (newTunerValueItem.containsKey("reheat") && newTunerValueItem.containsKey("min") && newTunerValueItem.containsKey("differential")) || newTunerValueItem.containsKey("leeway") || newTunerValueItem.containsKey("proportional");
+    }
+
+
     private void updateModuleData(String equipRef) {
         tuners.clear();
         tunerExpandableLayoutHelper = new TunerExpandableLayoutHelper(getActivity(), recyclerViewTuner, this, this,2, tunerGroupType);
diff --git a/app/src/main/res/layout-xlarge/fragment_installeroption.xml b/app/src/main/res/layout-xlarge/fragment_installeroption.xml
index 788a7352d..c1b4e19bc 100644
--- a/app/src/main/res/layout-xlarge/fragment_installeroption.xml
+++ b/app/src/main/res/layout-xlarge/fragment_installeroption.xml
@@ -289,7 +289,7 @@
                 android:layout_marginTop="36dp"
                 android:background="@drawable/toggle_selector"
                 android:checked="false"
-                android:enabled="false"
+                android:enabled="true"
                 android:textOff=""
                 android:textOn=""
                 android:visibility="gone" />
diff --git a/app/src/main/res/layout/fragment_installeroption.xml b/app/src/main/res/layout/fragment_installeroption.xml
index 788a7352d..c1b4e19bc 100644
--- a/app/src/main/res/layout/fragment_installeroption.xml
+++ b/app/src/main/res/layout/fragment_installeroption.xml
@@ -289,7 +289,7 @@
                 android:layout_marginTop="36dp"
                 android:background="@drawable/toggle_selector"
                 android:checked="false"
-                android:enabled="false"
+                android:enabled="true"
                 android:textOff=""
                 android:textOn=""
                 android:visibility="gone" />
diff --git a/app/src/main/res/values/preference_keys.xml b/app/src/main/res/values/preference_keys.xml
index 3881b43b4..f0983932a 100644
--- a/app/src/main/res/values/preference_keys.xml
+++ b/app/src/main/res/values/preference_keys.xml
@@ -13,4 +13,5 @@
     <string name="USE_SETUP_PASSWORD_KEY">use_setup_password</string>
     <string name="USE_SAME_SETTINGS_PASSWORD_KEY">use_same_settings_password</string>
     <string name="USE_SAME_TEMP_ALL_DAYS">use_same_temp_all_days</string>
+    <string name="USE_CELSIUS_KEY">use_celsius_key</string>
 </resources>
diff --git a/logic/src/main/java/a75f/io/logic/bo/util/UnitUtils.java b/logic/src/main/java/a75f/io/logic/bo/util/UnitUtils.java
index 200ca6ad8..71e72e147 100644
--- a/logic/src/main/java/a75f/io/logic/bo/util/UnitUtils.java
+++ b/logic/src/main/java/a75f/io/logic/bo/util/UnitUtils.java
@@ -8,7 +8,25 @@ public class UnitUtils {
      * @return
      */
     public static double celsiusToFahrenheit(double T) {
-        return (T * 9/5) + 32;
+        return CCUUtils.roundToTwoDecimal((T*9/5)+32);
+    }
+
+    public static double fahrenheitToCelsius(double T) {
+        return CCUUtils.roundToTwoDecimal((T-32)*5/9);
+    }
+    public static double celsiusToFahrenheitUnitChange(double T){
+        return CCUUtils.roundToTwoDecimal(T*1.8);
+    }
+    public static double fahrenheitToCelsiusUnitChange(double T) {
+        return CCUUtils.roundToTwoDecimal(T/1.8);
+    }
+    public static double round(double value, int precision) {
+        int scale = (int) Math.pow(10, precision);
+        return (double) Math.round(value * scale) / scale;
+    }
+    public static double roundToHalf(double d)
+    {
+        return 0.5 * Math.round(d * 2);
     }
     
 }
diff --git a/logic/src/main/java/a75f/io/logic/tuners/GenericTuners.java b/logic/src/main/java/a75f/io/logic/tuners/GenericTuners.java
index 0dface66d..f9f8d7c37 100644
--- a/logic/src/main/java/a75f/io/logic/tuners/GenericTuners.java
+++ b/logic/src/main/java/a75f/io/logic/tuners/GenericTuners.java
@@ -46,7 +46,22 @@ class GenericTuners {
         String buildingLimitMinId = hayStack.addPoint(buildingLimitMin);
         hayStack.writePointForCcuUser(buildingLimitMinId, TunerConstants.SYSTEM_DEFAULT_VAL_LEVEL,TunerConstants.BUILDING_LIMIT_MIN, 0);
         hayStack.writeHisValById(buildingLimitMinId, TunerConstants.BUILDING_LIMIT_MIN);
-    
+
+        Point useCelsius = new Point.Builder()
+                .setDisplayName(equipDis+"-"+"useCelsius")
+                .setSiteRef(siteRef)
+                .setEquipRef(equipRef).setHisInterpolate("cov")
+                .addMarker("tuner").addMarker("default").addMarker("writable").addMarker("his").addMarker("his").addMarker("useCelsius")
+                .addMarker("system").addMarker("building").addMarker("enabled").addMarker("sp").setIncrementVal("1")
+                .setEnums("false,true").setTunerGroup(TunerConstants.GENERIC_TUNER_GROUP)
+                .setMinVal("0")
+                .setMaxVal("1")
+                .setTz(tz)
+                .build();
+        String useCelsiusId = hayStack.addPoint(useCelsius);
+        hayStack.writePointForCcuUser(useCelsiusId, TunerConstants.USE_CELSIUS_FLAG_DISABLED,TunerConstants.USE_CELSIUS_FLAG_ENABLED, 0);
+        hayStack.writeHisValById(useCelsiusId, TunerConstants.USE_CELSIUS_FLAG_ENABLED);
+
         Point buildingLimitMax = new Point.Builder()
                                      .setDisplayName(equipDis+"-"+"buildingLimitMax")
                                      .setSiteRef(siteRef)
diff --git a/logic/src/main/java/a75f/io/logic/tuners/TunerConstants.java b/logic/src/main/java/a75f/io/logic/tuners/TunerConstants.java
index 1c94df4ed..3d7b05c52 100644
--- a/logic/src/main/java/a75f/io/logic/tuners/TunerConstants.java
+++ b/logic/src/main/java/a75f/io/logic/tuners/TunerConstants.java
@@ -95,6 +95,8 @@ public class TunerConstants
     public static final int VAV_DEFAULT_VAL_LEVEL = 17;
     public static final int VAV_BUILDING_VAL_LEVEL = 16;
 	public static final int MANUAL_OVERRIDE_VAL_LEVEL = 7;
+    public static final double USE_CELSIUS_FLAG_ENABLED = 1.0;
+    public static final int USE_CELSIUS_FLAG_DISABLED = 0;
 
     public static final double STANDALONE_HEATING_DEADBAND_DEFAULT = 2.0;//Default deadband value based on dual temp diff 70 and 74 ((74-70)/2.0)
     public static final double STANDALONE_COOLING_DEADBAND_DEFAULT = 2.0;
-- 
2.31.0.windows.1

