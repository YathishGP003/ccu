From 5a0f78275a49c79a9110b2e6c18fa141a928d6a4 Mon Sep 17 00:00:00 2001
From: Manjunath Kundaragi <mkundaragi@75f.io>
Date: Tue, 14 Jun 2022 15:56:24 +0530
Subject: [PATCH 09/50] Added Daig migration 1. Checking the diag points has 
 gateway reff if no adding to diag eqip 2. If there is no local diag points,
 than fetching from silo

---
 .../main/java/a75f/io/logic/util/MigrationUtil.java   | 11 +++++------
 1 file changed, 5 insertions(+), 6 deletions(-)

diff --git a/logic/src/main/java/a75f/io/logic/util/MigrationUtil.java b/logic/src/main/java/a75f/io/logic/util/MigrationUtil.java
index 19748f1fd..0dcfd1ccd 100644
--- a/logic/src/main/java/a75f/io/logic/util/MigrationUtil.java
+++ b/logic/src/main/java/a75f/io/logic/util/MigrationUtil.java
@@ -112,7 +112,7 @@ public class MigrationUtil {
         // Create create fresh daig points.
 
         HashMap ccu = ccuHsApi.readEntity("device and ccu");
-        if (ccu.size() == 0) {
+        if (ccu.isEmpty()) {
             Log.i(TAG_CCU_MIGRATION_UTIL, "doDiagPointsMigration: ");
             return;
         }
@@ -120,19 +120,18 @@ public class MigrationUtil {
         HashMap diag = ccuHsApi.readEntity("equip and diag");
         if (!diag.isEmpty()) {
             Log.i(TAG_CCU_MIGRATION_UTIL, "diag points are available ");
-            // Diag are present so check with def
+            // Diag are present so check with gatewayRef
             Equip diagEquip = new Equip.Builder().setHashMap(diag).build();
             if(!diagEquip.getMarkers().contains("gatewayRef")){
                 // Update gateway reff
                 Log.i(TAG_CCU_MIGRATION_UTIL, "adding gateway reference");
-                Equip systemEquip = new Equip.Builder()
-                        .setHashMap(ccuHsApi.read("system and equip")).build();
-                ccuHsApi.updateDiagGatewayRef(systemEquip.getId());
+                ccuHsApi.updateDiagGatewayRef(ccu.get("gatewayRef").toString());
             }
         }else{
-            Log.i(TAG_CCU_MIGRATION_UTIL, "Diag points are not avaiable Restoring daig equips");
+            Log.i(TAG_CCU_MIGRATION_UTIL, "Diag points are not available Restoring daig equips");
             // Locally diag points are missing check at silo
             new RestoreCCU().getDiagEquipOfCCU(ccu.get("equipRef").toString());
+
         }
 
 
-- 
2.31.0.windows.1

