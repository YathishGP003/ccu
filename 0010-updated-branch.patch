From d676df138c264e0ad42ce1b1ef27a2f4ac32ee47 Mon Sep 17 00:00:00 2001
From: Bharathpanchakshari
 <33091312+Bharathpanchakshari@users.noreply.github.com>
Date: Mon, 27 Jun 2022 16:04:57 +0530
Subject: [PATCH 10/25] updated branch

---
 .../registration/InstallerOptions.java        | 25 ++++++++++++-------
 .../renatus/schedules/SchedulerFragment.java  | 10 ++++++++
 2 files changed, 26 insertions(+), 9 deletions(-)

diff --git a/app/src/main/java/a75f/io/renatus/registration/InstallerOptions.java b/app/src/main/java/a75f/io/renatus/registration/InstallerOptions.java
index 6f8174adb..b7876f693 100644
--- a/app/src/main/java/a75f/io/renatus/registration/InstallerOptions.java
+++ b/app/src/main/java/a75f/io/renatus/registration/InstallerOptions.java
@@ -250,7 +250,11 @@ public class InstallerOptions extends Fragment {
         toggleCelsius.setVisibility(View.VISIBLE);
         useCelsius = CCUHsApi.getInstance().readEntity("displayUnit");
 
-        toggleCelsius.setChecked(getTuner(useCelsius.get("id").toString()) == TunerConstants.USE_CELSIUS_FLAG_ENABLED);
+        if( (double) getTuner(useCelsius.get("id").toString())==TunerConstants.USE_CELSIUS_FLAG_ENABLED) {
+           toggleCelsius.setChecked(true);
+        } else {
+           toggleCelsius.setChecked(false);
+        }
 
         if (ccuId != null) {
             ccuUid = CCUHsApi.getInstance().getCcuRef().toString();
@@ -397,16 +401,19 @@ public class InstallerOptions extends Fragment {
 
         getTempValues();
 
-        toggleCelsius.setOnCheckedChangeListener((buttonView, isChecked) -> {
+        toggleCelsius.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {
+            @Override
+            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
 
-            if(isChecked) {
-                CCUHsApi.getInstance().writePoint(useCelsius.get("id").toString(), TunerConstants.TUNER_BUILDING_VAL_LEVEL,
-                        CCUHsApi.getInstance().getCCUUserName(), 1.0, 0);
-            } else {
-                CCUHsApi.getInstance().writePoint(useCelsius.get("id").toString(), TunerConstants.TUNER_BUILDING_VAL_LEVEL,
-                        CCUHsApi.getInstance().getCCUUserName(), 0.0, 0);
+                if(isChecked) {
+                    CCUHsApi.getInstance().writePoint(useCelsius.get("id").toString(), TunerConstants.TUNER_BUILDING_VAL_LEVEL,
+                            CCUHsApi.getInstance().getCCUUserName(), 1.0, 0);
+                } else {
+                    CCUHsApi.getInstance().writePoint(useCelsius.get("id").toString(), TunerConstants.TUNER_BUILDING_VAL_LEVEL,
+                            CCUHsApi.getInstance().getCCUUserName(), 0.0, 0);
+                }
+                getTempValues();
             }
-            getTempValues();
         });
 
         toggleBACnet.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {
diff --git a/app/src/main/java/a75f/io/renatus/schedules/SchedulerFragment.java b/app/src/main/java/a75f/io/renatus/schedules/SchedulerFragment.java
index 7bd8352bb..155dd6b04 100644
--- a/app/src/main/java/a75f/io/renatus/schedules/SchedulerFragment.java
+++ b/app/src/main/java/a75f/io/renatus/schedules/SchedulerFragment.java
@@ -68,6 +68,7 @@ import a75f.io.logger.CcuLog;
 import a75f.io.logic.DefaultSchedules;
 import a75f.io.logic.L;
 import a75f.io.logic.jobs.ScheduleProcessJob;
+import a75f.io.logic.tuners.TunerConstants;
 import a75f.io.renatus.R;
 import a75f.io.renatus.SystemFragment;
 import a75f.io.renatus.schedules.ManualSchedulerDialogFragment.ManualScheduleDialogListener;
@@ -976,9 +977,18 @@ public class SchedulerFragment extends DialogFragment implements ManualScheduleD
     private String getDayString(Schedule.Days day) {
         return ScheduleUtil.getDayString(day.getDay()+1);
     }
+    private static float roundToHalf(float d) {
+        return Math.round(d * 2) / 2.0f;
+    }
     
     private void drawSchedule(int position, double heatingTemp, double coolingTemp, int startTimeHH, int endTimeHH, int startTimeMM, int endTimeMM, DAYS day, boolean intersection) {
 
+        HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("displayUnit");
+
+        if(getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED) {
+            coolingTemp = roundToHalf((float) fahrenheitToCelsius(coolingTemp));
+            heatingTemp = roundToHalf((float) fahrenheitToCelsius(heatingTemp));
+        }
 
         String strminTemp = FontManager.getColoredSpanned(Double.toString(coolingTemp), colorMinTemp);
         String strmaxTemp = FontManager.getColoredSpanned(Double.toString(heatingTemp), colorMaxTemp);
-- 
2.31.0.windows.1

