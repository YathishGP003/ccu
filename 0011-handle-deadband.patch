From 93c6dd2072ff76ae5682d4c02b1fbef22cd9ed03 Mon Sep 17 00:00:00 2001
From: Samjith Sadasivan <samjith@75f.io>
Date: Tue, 14 Jun 2022 17:21:48 -0500
Subject: [PATCH 11/50] handle deadband

---
 .../a75/io/algos/GenericPIController.java     |  2 +-
 .../bo/building/truecfm/TrueCfmLoopState.java |  3 ++-
 .../io/logic/bo/building/vav/VavProfile.java  | 21 ++++++++++++++++++-
 3 files changed, 23 insertions(+), 3 deletions(-)

diff --git a/algos/src/main/java/a75/io/algos/GenericPIController.java b/algos/src/main/java/a75/io/algos/GenericPIController.java
index 96856fabc..4169b94a1 100644
--- a/algos/src/main/java/a75/io/algos/GenericPIController.java
+++ b/algos/src/main/java/a75/io/algos/GenericPIController.java
@@ -57,7 +57,7 @@ public class GenericPIController
     }
     
     public void calculateProportionalError() {
-        proportionalError = limitedError * proportionalGain;
+        proportionalError = Math.max(limitedError * proportionalGain, 0);
     }
     
     public void calculateIntegralError() {
diff --git a/logic/src/main/java/a75f/io/logic/bo/building/truecfm/TrueCfmLoopState.java b/logic/src/main/java/a75f/io/logic/bo/building/truecfm/TrueCfmLoopState.java
index 546e3d57f..5ee2e9bf1 100644
--- a/logic/src/main/java/a75f/io/logic/bo/building/truecfm/TrueCfmLoopState.java
+++ b/logic/src/main/java/a75f/io/logic/bo/building/truecfm/TrueCfmLoopState.java
@@ -10,5 +10,6 @@ public enum TrueCfmLoopState {
     HEATING_COOLING_MIN,
     HEATING_COOLING_MAX,
     HEATING_HEATING_MIN,
-    HEATING_HEATING_MAX
+    HEATING_HEATING_MAX,
+    DEAD_BAND_CFM
 }
diff --git a/logic/src/main/java/a75f/io/logic/bo/building/vav/VavProfile.java b/logic/src/main/java/a75f/io/logic/bo/building/vav/VavProfile.java
index 2b8cca335..42d79774d 100644
--- a/logic/src/main/java/a75f/io/logic/bo/building/vav/VavProfile.java
+++ b/logic/src/main/java/a75f/io/logic/bo/building/vav/VavProfile.java
@@ -25,6 +25,7 @@ import a75f.io.logic.bo.building.hvac.Damper;
 import a75f.io.logic.bo.building.hvac.Valve;
 import a75f.io.logic.bo.building.hvac.VavUnit;
 import a75f.io.logic.bo.building.system.SystemController;
+import a75f.io.logic.bo.building.system.SystemState;
 import a75f.io.logic.bo.building.system.vav.VavSystemProfile;
 import a75f.io.logic.bo.building.truecfm.TrueCFMUtil;
 import a75f.io.logic.bo.building.truecfm.TrueCfmLoopState;
@@ -33,6 +34,7 @@ import a75f.io.logic.tuners.TunerUtil;
 
 import static a75f.io.logic.bo.building.ZonePriority.NONE;
 import static a75f.io.logic.bo.building.ZoneState.COOLING;
+import static a75f.io.logic.bo.building.ZoneState.DEADBAND;
 import static a75f.io.logic.bo.building.ZoneState.HEATING;
 import static a75f.io.logic.bo.building.truecfm.TrueCfmLoopState.*;
 
@@ -560,13 +562,28 @@ public abstract class VavProfile extends ZoneProfile {
                  " updateDamperSystemHeating cfmLoopOp "+cfmLoopOp+" CFM allowed:"+minCfmHeating);
     }
     
+    private void updateDamperZoneDeadband(CCUHsApi hayStack, String equipId, double currentCfm, SystemController.State systemState) {
+        double minCfm = systemState == SystemController.State.COOLING ? TrueCFMUtil.getMinCFMCooling(hayStack, equipId) :
+                                                    TrueCFMUtil.getMinCFMReheating(hayStack, equipId);
+        double cfmLoopOp;
+        if (cfmLoopState != DEAD_BAND_CFM) {
+            cfmLoopState = DEAD_BAND_CFM;
+            cfmControlLoop.reset();
+        }
+        cfmLoopOp = cfmControlLoop.getLoopOutput(minCfm, currentCfm);
+        updateDamperForMinCfm(cfmLoopOp);
+        
+        CcuLog.i(L.TAG_CCU_ZONE,
+                 " updateDamperZoneDeadband cfmLoopOp "+cfmLoopOp+" CFM required:"+minCfm);
+    }
+    
     private void updateDamperForMinCfm(double cfmLoopOp) {
         if (damper.currentPosition > 0) {
             CcuLog.d(L.TAG_CCU_ZONE,
                      "updateDamperForMinCfm newDamperPos: "+damper.currentPosition+" cfmLoopOp "+cfmLoopOp);
             damper.currentPosition += damper.currentPosition * cfmLoopOp/100;
         } else {
-            damper.currentPosition = (int)cfmLoopOp;
+            damper.currentPosition = Math.max((int)cfmLoopOp, 0);
         }
     }
     
@@ -597,6 +614,8 @@ public abstract class VavProfile extends ZoneProfile {
             updateDamperSystemCoolingZoneHeating(hayStack, equipId, currentCfm);
         } else if (systemState == SystemController.State.HEATING) {
             updateDamperSystemHeating(hayStack, equipId, currentCfm);
+        } else if (state == DEADBAND){
+            updateDamperZoneDeadband(hayStack, equipId, currentCfm, systemState);
         }
         damper.currentPosition = Math.min(damper.currentPosition, 100);
         CcuLog.i(L.TAG_CCU_ZONE,
-- 
2.31.0.windows.1

