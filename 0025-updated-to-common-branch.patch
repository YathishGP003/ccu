From 686a95db604b94c7907b989426c0bda655882bd0 Mon Sep 17 00:00:00 2001
From: Bharathpanchakshari
 <33091312+Bharathpanchakshari@users.noreply.github.com>
Date: Tue, 21 Jun 2022 17:26:01 +0530
Subject: [PATCH 25/50] updated to common branch

---
 .../registration/InstallerOptions.java        |  3 +-
 .../tuners/DialogTunerPriorityArray.java      | 52 +++++++++++++++++--
 .../tuners/TunerExpandableGridAdapter.java    |  2 +-
 .../a75f/io/renatus/tuners/TunerFragment.java |  2 +-
 .../java/a75f/io/logic/bo/util/UnitUtils.java | 52 +++++++++----------
 5 files changed, 75 insertions(+), 36 deletions(-)

diff --git a/app/src/main/java/a75f/io/renatus/registration/InstallerOptions.java b/app/src/main/java/a75f/io/renatus/registration/InstallerOptions.java
index 683cbceea..a5962c475 100644
--- a/app/src/main/java/a75f/io/renatus/registration/InstallerOptions.java
+++ b/app/src/main/java/a75f/io/renatus/registration/InstallerOptions.java
@@ -248,7 +248,7 @@ public class InstallerOptions extends Fragment {
 
         textCelsiusEnable.setVisibility(View.VISIBLE);
         toggleCelsius.setVisibility(View.VISIBLE);
-        HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("useCelsius");
+        HashMap<Object, Object> useCelsius;
 
         useCelsius = CCUHsApi.getInstance().readEntity("displayUnit");
 
@@ -408,6 +408,7 @@ public class InstallerOptions extends Fragment {
         toggleCelsius.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {
             @Override
             public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
+                HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("displayUnit");
 
                 if(isChecked) {
                     CCUHsApi.getInstance().writePoint(useCelsius.get("id").toString(), TunerConstants.TUNER_BUILDING_VAL_LEVEL,
diff --git a/app/src/main/java/a75f/io/renatus/tuners/DialogTunerPriorityArray.java b/app/src/main/java/a75f/io/renatus/tuners/DialogTunerPriorityArray.java
index 888005f43..e6f0fc850 100644
--- a/app/src/main/java/a75f/io/renatus/tuners/DialogTunerPriorityArray.java
+++ b/app/src/main/java/a75f/io/renatus/tuners/DialogTunerPriorityArray.java
@@ -77,7 +77,7 @@ public class DialogTunerPriorityArray extends BaseDialogFragment implements Prio
     LinearLayout layoutTitle;
     Prefs prefs;
     double defaultVal;
-    HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("useCelsius");
+    HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("displayUnit");
 
 
     private void configureArguments(HashMap tunerItem, String tunerGroupType, TunerGroupItem tunerGroupItem) {
@@ -281,13 +281,25 @@ public class DialogTunerPriorityArray extends BaseDialogFragment implements Prio
     @Override
     public void onViewCreated(View view, @Nullable Bundle savedInstanceState) {
 
+        defaultVal = getTunerDefaultValue(tunerItemSelected.get("id").toString());
+
+        tunerName = tunerItemSelected.get("dis").toString();
+        if( (double) MasterControlView.getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED) {
+            if (tunerItemSelected.containsKey("unit") && tunerItemSelected.get("unit").toString().equals("\u00B0F") || tunerItemSelected.get("unit").toString().equals("\u00B0C")) {
+                if (doesPointNeedRelativeConversion()) {
+                    defaultVal = roundToHalf(fahrenheitToCelsiusUnitChange(defaultVal));
+                } else {
+                    defaultVal = Math.round(fahrenheitToCelsius(defaultVal));
+                }
+            }
+        }
          String tunerName = tunerItemSelected.get("dis").toString();
         if (tunerItemSelected.containsKey("unit")) {
             textTunerName.setText(tunerName.substring(tunerName.lastIndexOf("-") + 1) + " (" + tunerItemSelected.get("unit").toString().toUpperCase() + ")");
-            textTunerDefaultValue.setText(getTunerDefaultValue(tunerItemSelected.get("id").toString()) + " (" + tunerItemSelected.get("unit").toString().toUpperCase() + ")");
+            textTunerDefaultValue.setText(defaultVal + " (" + tunerItemSelected.get("unit").toString().toUpperCase() + ")");
         } else {
             textTunerName.setText(tunerName.substring(tunerName.lastIndexOf("-") + 1));
-            textTunerDefaultValue.setText("" + getTunerDefaultValue(tunerItemSelected.get("id").toString()));
+            textTunerDefaultValue.setText("" + defaultVal);
         }
 
         textTunerGroupTitle.setText(tunerGroupSelected.getName());
@@ -313,6 +325,9 @@ public class DialogTunerPriorityArray extends BaseDialogFragment implements Prio
         });
         buttonCancel.setOnClickListener(v -> dismiss());
     }
+    public boolean doesPointNeedRelativeConversion() {
+        return  tunerItemSelected.containsKey("deadband") || tunerItemSelected.containsKey("setback") || tunerItemSelected.containsKey("abnormal") || (tunerItemSelected.containsKey("spread") && tunerItemSelected.containsKey("user") && !tunerItemSelected.containsKey("multiplier")) || tunerItemSelected.containsKey("sat") && tunerItemSelected.containsKey("spmax") || tunerItemSelected.containsKey("spmin") || tunerItemSelected.containsKey("spres") || tunerItemSelected.containsKey("spinit") || tunerItemSelected.containsKey("sptrim") || tunerItemSelected.containsKey("spresmax") || (tunerItemSelected.containsKey("reheat") && tunerItemSelected.containsKey("min") && tunerItemSelected.containsKey("differential")) || tunerItemSelected.containsKey("leeway") || tunerItemSelected.containsKey("proportional");
+    }
 
 
     public double getTunerValue(String id) {
@@ -368,14 +383,25 @@ public class DialogTunerPriorityArray extends BaseDialogFragment implements Prio
         return 0;
     }
 
-    public String getTunerValue(String id, String level) {
+    private String getTunerValue(String id, String level) {
         CCUHsApi hayStack = CCUHsApi.getInstance();
         ArrayList values = hayStack.readPoint(id);
         if (values != null && values.size() > 0) {
             for (int l = 1; l <= values.size(); l++) {
                 HashMap valMap = ((HashMap) values.get(l - 1));
                 if (valMap.get("level").toString().equals(level) && valMap.get("val") != null) {
-                    return valMap.get("val").toString();
+                    tunerVal = valMap.get("val").toString();
+                    if( (double) MasterControlView.getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED) {
+                        if (tunerItemSelected.containsKey("unit") && tunerItemSelected.get("unit").toString().equals("\u00B0F") || tunerItemSelected.get("unit").toString().equals("\u00B0C")) {
+                            if (doesPointNeedRelativeConversion()) {
+                                tunerVal = String.valueOf(roundToHalf(fahrenheitToCelsiusUnitChange(Double.parseDouble(valMap.get("val").toString()))));
+                            } else {
+                                tunerVal = String.valueOf(Math.round(fahrenheitToCelsius(Double.parseDouble(valMap.get("val").toString()))));
+                            }
+                        }
+
+                    }
+                    return tunerVal;
                 }
             }
         }
@@ -401,6 +427,7 @@ public class DialogTunerPriorityArray extends BaseDialogFragment implements Prio
             buttonUndo.setVisibility(View.GONE);
             buttonSaveAlert.setEnabled(false);
             String levelName = "Building";
+            prefs = new Prefs(getContext().getApplicationContext());
             int level;
             if (position == 15) {
                 levelName = "Building";
@@ -448,6 +475,21 @@ public class DialogTunerPriorityArray extends BaseDialogFragment implements Prio
                 double maxValueDb = (Double.parseDouble((tunerItemSelected.get("maxVal").toString())));
                 double incrementValDb = (Double.parseDouble(tunerItemSelected.get("incrementVal").toString()));
 
+                if( (double) MasterControlView.getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED) {
+                    if (tunerItemSelected.containsKey("unit") && tunerItemSelected.get("unit").toString().equals("\u00B0F") || tunerItemSelected.get("unit").toString().equals("\u00B0C")) {
+                        prefs.setBoolean(tunerItemSelected.get("id").toString(), true);
+                        if (doesPointNeedRelativeConversion()) {
+                            maxValueDb = roundToHalf(fahrenheitToCelsiusUnitChange(maxValueDb));
+                            minValueDb = roundToHalf(fahrenheitToCelsiusUnitChange(minValueDb));
+                            currentValueDb = roundToHalf(fahrenheitToCelsiusUnitChange(currentValueDb));
+                        } else {
+                            minValueDb = roundToHalf(fahrenheitToCelsius(minValueDb));
+                            maxValueDb = roundToHalf(fahrenheitToCelsius(maxValueDb));
+                            currentValueDb = roundToHalf(fahrenheitToCelsius(currentValueDb));
+                        }
+                    }
+                }
+
                 Log.i("TunersUI", "currentValue:" + currentValue + " minValue:" + minValue + " maxValue:" + maxValue + " incVal:" + incrementVal);
 
                 ArrayList<String> valueList = new ArrayList<>();
diff --git a/app/src/main/java/a75f/io/renatus/tuners/TunerExpandableGridAdapter.java b/app/src/main/java/a75f/io/renatus/tuners/TunerExpandableGridAdapter.java
index 338d363b8..d1992866e 100644
--- a/app/src/main/java/a75f/io/renatus/tuners/TunerExpandableGridAdapter.java
+++ b/app/src/main/java/a75f/io/renatus/tuners/TunerExpandableGridAdapter.java
@@ -54,7 +54,7 @@ public class TunerExpandableGridAdapter extends RecyclerView.Adapter<TunerExpand
     TunerGroupItem previousOpenGroup = null;
     String tunerGroupType = "Building";
     SharedPreferences mPreferences;
-    HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("useCelsius");
+    HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("displayUnit");
 
     public TunerExpandableGridAdapter(Context context, ArrayList<Object> dataArrayList,
                                       final GridLayoutManager gridLayoutManager, TunerItemClickListener itemClickListener,
diff --git a/app/src/main/java/a75f/io/renatus/tuners/TunerFragment.java b/app/src/main/java/a75f/io/renatus/tuners/TunerFragment.java
index ceb948133..ed2c695c0 100644
--- a/app/src/main/java/a75f/io/renatus/tuners/TunerFragment.java
+++ b/app/src/main/java/a75f/io/renatus/tuners/TunerFragment.java
@@ -127,7 +127,7 @@ public class TunerFragment extends BaseDialogFragment implements TunerItemClickL
         cancelTunerUpdate = view.findViewById(R.id.buttonCancel);
         editChangeReason = view.findViewById(R.id.editChangeReason);
         editTunerSearch = view.findViewById(R.id.editTunerSearch);
-        HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("useCelsius");
+        HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("displayUnit");
         saveTunerValues.setEnabled(false);
         //Default Show System Tuners
         //TODO: revert building tuners
diff --git a/logic/src/main/java/a75f/io/logic/bo/util/UnitUtils.java b/logic/src/main/java/a75f/io/logic/bo/util/UnitUtils.java
index c1b5a11d6..66e016cbf 100644
--- a/logic/src/main/java/a75f/io/logic/bo/util/UnitUtils.java
+++ b/logic/src/main/java/a75f/io/logic/bo/util/UnitUtils.java
@@ -1,53 +1,49 @@
 package a75f.io.logic.bo.util;
 
 public class UnitUtils {
-    
+
     /**
      * Convert celsius to Fahrenheit
+     *
      * @param temperature
      * @return
      */
     public static double celsiusToFahrenheit(double temperature) {
-        return CCUUtils.roundToTwoDecimal((temperature * 9/5) + 32);
+        return CCUUtils.roundToTwoDecimal((temperature * 9 / 5) + 32);
     }
 
     public static double fahrenheitToCelsiusTwoDecimal(double temperature) {
-        return CCUUtils.roundToOneDecimal((temperature - 32) * 5/9);
+        return CCUUtils.roundToOneDecimal((temperature - 32) * 5 / 9);
     }
 
     public static double fahrenheitToCelsius(double temperature) {
-        double celsiusTemperature ;
-        celsiusTemperature =((temperature - 32) * 5/9);
-        double decimalValue = celsiusTemperature -(long) celsiusTemperature;
+        double celsiusTemperature;
+        celsiusTemperature = ((temperature - 32) * 5 / 9);
+        double decimalValue = celsiusTemperature - (long) celsiusTemperature;
 
         if (decimalValue > 0.01 && decimalValue <= 0.3) {
-            celsiusTemperature = (Math.round(celsiusTemperature- decimalValue));
+            celsiusTemperature = (Math.round(celsiusTemperature - decimalValue));
         } else if (decimalValue > 0.3 && decimalValue <= 0.7) {
-            celsiusTemperature = (Math.round(celsiusTemperature- decimalValue) + 0.5);
+            celsiusTemperature = (Math.round(celsiusTemperature - decimalValue) + 0.5);
         } else if (decimalValue > 0.7 && decimalValue <= 0.99) {
             celsiusTemperature = (Math.round(celsiusTemperature - decimalValue) + 1.0);
         }
         return celsiusTemperature;
-    public static double celsiusToFahrenheit(double T) {
-        return CCUUtils.roundToTwoDecimal((T*9/5)+32);
     }
 
-    public static double fahrenheitToCelsius(double T) {
-        return CCUUtils.roundToTwoDecimal((T-32)*5/9);
-    }
-    public static double celsiusToFahrenheitUnitChange(double T){
-        return CCUUtils.roundToTwoDecimal(T*1.8);
-    }
-    public static double fahrenheitToCelsiusUnitChange(double T) {
-        return CCUUtils.roundToTwoDecimal(T/1.8);
-    }
-    public static double round(double value, int precision) {
-        int scale = (int) Math.pow(10, precision);
-        return (double) Math.round(value * scale) / scale;
-    }
-    public static double roundToHalf(double d)
-    {
-        return 0.5 * Math.round(d * 2);
-    }
-    
+        public static double celsiusToFahrenheitUnitChange ( double temperature){
+            return CCUUtils.roundToTwoDecimal(temperature * 1.8);
+        }
+        public static double fahrenheitToCelsiusUnitChange ( double temperature){
+            return CCUUtils.roundToTwoDecimal(temperature / 1.8);
+        }
+        public static double round ( double value, int precision){
+            int scale = (int) Math.pow(10, precision);
+            return (double) Math.round(value * scale) / scale;
+        }
+        public static double roundToHalf ( double d)
+        {
+            return 0.5 * Math.round(d * 2);
+        }
+
 }
-- 
2.31.0.windows.1

