From 4e425983c4613b6f2676f7fb5de0b340712c1215 Mon Sep 17 00:00:00 2001
From: Bharathpanchakshari
 <33091312+Bharathpanchakshari@users.noreply.github.com>
Date: Thu, 30 Jun 2022 13:43:23 +0530
Subject: [PATCH 44/50] final updated version

---
 .../renatus/schedules/SchedulerFragment.java   | 16 +++++++++++++++-
 .../a75f/io/renatus/tuners/TunerFragment.java  |  5 ++---
 .../java/a75f/io/logic/bo/util/UnitUtils.java  | 18 ++++++++++++++++++
 3 files changed, 35 insertions(+), 4 deletions(-)

diff --git a/app/src/main/java/a75f/io/renatus/schedules/SchedulerFragment.java b/app/src/main/java/a75f/io/renatus/schedules/SchedulerFragment.java
index 79f7af3e5..3fc11c111 100644
--- a/app/src/main/java/a75f/io/renatus/schedules/SchedulerFragment.java
+++ b/app/src/main/java/a75f/io/renatus/schedules/SchedulerFragment.java
@@ -1,5 +1,8 @@
 package a75f.io.renatus.schedules;
 
+import static a75f.io.renatus.views.MasterControl.MasterControlView.getTuner;
+
+import static a75f.io.logic.bo.util.UnitUtils.fahrenheitToCelsius;
 import static a75f.io.usbserial.UsbModbusService.TAG;
 
 import android.app.AlertDialog;
@@ -67,6 +70,7 @@ import a75f.io.logic.DefaultSchedules;
 import a75f.io.logic.L;
 import a75f.io.logic.jobs.ScheduleProcessJob;
 import a75f.io.logic.schedule.SpecialSchedule;
+import a75f.io.logic.tuners.TunerConstants;
 import a75f.io.renatus.R;
 import a75f.io.renatus.schedules.ManualSchedulerDialogFragment.ManualScheduleDialogListener;
 import a75f.io.renatus.util.FontManager;
@@ -1096,10 +1100,20 @@ public class SchedulerFragment extends DialogFragment implements ManualScheduleD
     private String getDayString(Schedule.Days day) {
         return ScheduleUtil.getDayString(day.getDay()+1);
     }
-    
+    private static float roundToHalf(float d) {
+        return Math.round(d * 2) / 2.0f;
+    }
+
     private void drawSchedule(int position, double heatingTemp, double coolingTemp, int startTimeHH, int endTimeHH, int startTimeMM, int endTimeMM, DAYS day, boolean intersection) {
 
 
+        HashMap<Object, Object> useCelsius = CCUHsApi.getInstance().readEntity("displayUnit");
+
+        if(getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED) {
+            coolingTemp = roundToHalf((float) fahrenheitToCelsius(coolingTemp));
+            heatingTemp = roundToHalf((float) fahrenheitToCelsius(heatingTemp));
+        }
+
         String strminTemp = FontManager.getColoredSpanned(Double.toString(coolingTemp), colorMinTemp);
         String strmaxTemp = FontManager.getColoredSpanned(Double.toString(heatingTemp), colorMaxTemp);
 
diff --git a/app/src/main/java/a75f/io/renatus/tuners/TunerFragment.java b/app/src/main/java/a75f/io/renatus/tuners/TunerFragment.java
index ed2c695c0..0dd981a6d 100644
--- a/app/src/main/java/a75f/io/renatus/tuners/TunerFragment.java
+++ b/app/src/main/java/a75f/io/renatus/tuners/TunerFragment.java
@@ -66,8 +66,7 @@ import a75f.io.renatus.util.Prefs;
 import a75f.io.renatus.views.MasterControl.MasterControlView;
 
 import static a75f.io.logic.bo.util.UnitUtils.celsiusToFahrenheit;
-import static a75f.io.logic.bo.util.UnitUtils.celsiusToFahrenheitUnitChange;
-import static a75f.io.logic.bo.util.UnitUtils.roundToHalf;
+import static a75f.io.logic.bo.util.UnitUtils.celsiusToFahrenheitRelativeChange;
 
 
 
@@ -336,7 +335,7 @@ public class TunerFragment extends BaseDialogFragment implements TunerItemClickL
                     if( (double) MasterControlView.getTuner(useCelsius.get("id").toString())== TunerConstants.USE_CELSIUS_FLAG_ENABLED  || prefs.getBoolean(newTunerValueItem.get("id").toString())) {
                         if (newTunerValueItem.containsKey("unit") && newTunerValueItem.get("unit").toString().equals("\u00B0F") || newTunerValueItem.get("unit").toString().equals("\u00B0C")) {
                             if (doesPointNeedRelativeConversion(newTunerValueItem)) {
-                                newTunerValueItem.replace("newValue", String.valueOf(roundToHalf(celsiusToFahrenheitUnitChange(Double.parseDouble(newTunerValueItem.get("newValue").toString())))));
+                                newTunerValueItem.replace("newValue", String.valueOf(celsiusToFahrenheitRelativeChange(Double.parseDouble(newTunerValueItem.get("newValue").toString()))));
                             } else {
                                 newTunerValueItem.replace("newValue", String.valueOf(Math.round(celsiusToFahrenheit(Double.parseDouble(newTunerValueItem.get("newValue").toString())))));
                             }
diff --git a/logic/src/main/java/a75f/io/logic/bo/util/UnitUtils.java b/logic/src/main/java/a75f/io/logic/bo/util/UnitUtils.java
index 196b52721..a6e5f6500 100644
--- a/logic/src/main/java/a75f/io/logic/bo/util/UnitUtils.java
+++ b/logic/src/main/java/a75f/io/logic/bo/util/UnitUtils.java
@@ -46,4 +46,22 @@ public class UnitUtils {
         return celsiusTemperature;
     }
 
+    public static double celsiusToFahrenheitRelativeChange(double temperature) {
+        double fahrenheitTemperature ;
+        fahrenheitTemperature = (temperature * 1.8);
+        double decimalValue = fahrenheitTemperature - (long) fahrenheitTemperature;
+
+        if (decimalValue > 0.01 && decimalValue <= 0.3) {
+            fahrenheitTemperature = (Math.round(fahrenheitTemperature- decimalValue));
+        } else if (decimalValue > 0.3 && decimalValue <= 0.7) {
+            fahrenheitTemperature = (Math.round(fahrenheitTemperature- decimalValue) + 0.5);
+        } else if (decimalValue > 0.7 && decimalValue <= 0.99) {
+            fahrenheitTemperature = (Math.round(fahrenheitTemperature - decimalValue) + 1.0);
+        }
+        return fahrenheitTemperature;
+
+    }
+
+
+
 }
-- 
2.31.0.windows.1

